<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¦'×§ ×œ×™×¡×˜ × ×™×§×™×•×Ÿ - ×§×‘×•×¦×ª × ×™×§×™×•×Ÿ ×™×•××™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            -webkit-tap-highlight-color: transparent;
        }
        .task-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            transition: transform 0.2s ease;
        }
        .status-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            border: 2px solid #e2e8f0;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1.25rem;
        }
        .btn-done.active {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #15803d;
            transform: scale(1.05);
        }
        .btn-not-done.active {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #b91c1c;
            transform: scale(1.05);
        }
        .reason-select {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .reason-select.visible {
            display: block;
        }
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        
        /* Animations */
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .animate-pop {
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Header Section -->
    <header class="p-6 bg-white border-b border-slate-200">
        <div class="max-w-md mx-auto">
            <h1 class="text-xl font-bold text-slate-800 text-center mb-1 text-blue-600">× ×™×§×™×•×Ÿ ×™×•××™ âœ¨</h1>
            <div id="currentTime" class="text-xs text-center text-slate-400 font-mono mb-1">00:00:00</div>
            <div id="currentDate" class="text-xs text-center text-slate-400 mb-4 tracking-wide">×˜×•×¢×Ÿ ×ª××¨×™×š...</div>
            
            <!-- Tab Switcher -->
            <div class="flex gap-2 mb-4">
                <button id="tabBtnA" onclick="window.switchTab('A')" class="tab-btn active flex-1 py-3 border-2 border-slate-200 rounded-xl font-bold text-sm text-slate-600">××‘× ×” A</button>
                <button id="tabBtnB" onclick="window.switchTab('B')" class="tab-btn flex-1 py-3 border-2 border-slate-200 rounded-xl font-bold text-sm text-slate-600">××‘× ×” B</button>
                <button id="tabBtnReports" onclick="window.switchTab('Reports')" class="tab-btn px-4 py-3 border-2 border-slate-200 rounded-xl font-bold text-sm text-slate-600">ğŸ“œ ×“×•×—×•×ª</button>
            </div>

            <div id="headerInputs" class="space-y-3">
                <div id="nameInputA">
                    <input type="text" id="workerNameA" placeholder="×©× ××“×•×•×— ××‘× ×” A..." class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-md focus:ring-2 focus:ring-blue-100 outline-none font-bold">
                </div>
                <div id="nameInputB" class="hidden">
                    <input type="text" id="workerNameB" placeholder="×©× ××“×•×•×— ××‘× ×” B..." class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-md focus:ring-2 focus:ring-blue-100 outline-none font-bold">
                </div>

                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 shadow-inner">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">×”×ª×§×“××•×ª ××‘× ×” <span id="progressLabel">A</span></span>
                        <span id="progressText" class="text-xs font-bold text-blue-600">0%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
                        <div id="progressBar" class="bg-blue-500 h-full transition-all duration-700 ease-out" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="p-4 max-w-md mx-auto min-h-[60vh]">
        
        <!-- Content Containers -->
        <div id="contentA" class="space-y-4">
            <h2 class="text-sm font-bold text-slate-500 mb-2 px-1 text-center">ğŸ—ï¸ ××©×™××•×ª ××‘× ×” A</h2>
            <div id="group-A" class="space-y-3"></div>
        </div>

        <div id="contentB" class="hidden space-y-4">
            <h2 class="text-sm font-bold text-slate-500 mb-2 px-1 text-center">ğŸ¢ ××‘× ×” B - ×§×¨×§×¢</h2>
            <div id="group-B-Ground" class="space-y-3"></div>
            
            <h2 class="text-sm font-bold text-slate-500 mb-2 mt-6 px-1 border-t pt-4 border-slate-200 text-center">ğŸ—ï¸ ××‘× ×” B - ×¢×œ×™×•×Ÿ</h2>
            <div id="group-B-Upper" class="space-y-3"></div>
        </div>

        <div id="contentReports" class="hidden space-y-4">
            <div class="flex justify-between items-center px-1 mb-2">
                <h2 class="text-sm font-bold text-slate-500">ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª ×“×™×•×•×—×™×</h2>
                <button id="exportCsvBtn" onclick="window.exportToCSV()" class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold border border-blue-100 hover:bg-blue-100 transition-colors">×™×™×¦× ×œ-CSV</button>
            </div>
            <div id="reportsHistoryList" class="space-y-3">
                <div class="text-center py-10 text-slate-400 text-sm italic">×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ...</div>
            </div>
        </div>

        <!-- Sticky Bottom Action (Visible for A/B tabs) -->
        <div id="actionButtons" class="pt-10 pb-10 space-y-3">
            <button id="sendReportBtn" onclick="window.attemptSend()" class="w-full bg-[#25D366] text-white py-4 rounded-xl flex items-center justify-center gap-3 text-lg font-bold shadow-md active:scale-[0.98] transition-all">
                <span id="btnLoader" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
                <svg id="whatsappIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                ×©×œ×— ×“×™×•×•×— ×œ×§×‘×•×¦×”
            </button>
            <button id="resetAllBtn" onclick="window.resetChecklist()" class="w-full py-3 text-slate-400 text-xs font-bold uppercase tracking-tighter hover:text-red-400 transition-colors">
                ××™×¤×•×¡ ×¨×©×™××” ×œ×™×•× ×—×“×©
            </button>
        </div>
    </main>

    <!-- Modal System -->
    <div id="customModal" class="hidden fixed inset-0 bg-slate-900/60 z-50 items-center justify-center p-6 backdrop-blur-sm">
        <div id="modalBox" class="bg-white p-8 rounded-3xl max-w-sm w-full text-center shadow-2xl transition-all duration-300">
            <div id="modalIcon" class="text-6xl mb-4 drop-shadow-lg">âœ¨</div>
            <h3 id="modalTitle" class="text-2xl font-black text-slate-800 mb-2"></h3>
            <p id="modalDescription" class="text-slate-500 text-md mb-8 leading-relaxed"></p>
            <div class="flex flex-col gap-3">
                <button id="modalActionBtn" onclick="window.confirmSend()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-all">×›×Ÿ, ×©×œ×— ×“×™×•×•×—</button>
                <button id="modalCloseBtn" onclick="window.closeModal()" class="w-full bg-slate-50 text-slate-400 py-3 rounded-2xl font-bold text-sm">×—×–×•×¨ ×œ×”×©×œ×™×</button>
            </div>
            <div class="mt-6 text-[10px] text-slate-300 font-bold uppercase tracking-widest">×¢×‘×•×“×” ××¢×•×œ×”, ××¢×¨×™×›×™× ××ª ×”××××¥! â¤ï¸</div>
        </div>
    </div>

    <!-- Firebase & Logic Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // -------------------------
        // Google Sheets (DB) CONFIG
        // -------------------------
        // Web App URL ×©×§×™×‘×œ×ª ××”-Apps Script:
        const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbzBkgurzHx9f-hqUfpVaN2Ok8KT1TsL9jhW9NBd_cP9WqmDGJOF7K4MVLwUTTNco-8elw/exec";
        // ×—×™×™×‘ ×œ×”×™×•×ª ×–×”×” ×œ-API_KEY ×©×”×’×“×¨×ª ×‘×§×•×“ ×©×œ Apps Script:
        const SHEETS_API_KEY = "cleaningdb_2025_secure_key_9F3xA2";

        // ×ª×•×¨ ××•×¤×œ×™×™×Ÿ ×œ×©××™×¨×” ×××™× ×” (×× ××™×Ÿ ×§×œ×™×˜×” / fetch × ×•×¤×œ):
        const SHEETS_QUEUE_KEY = "cleaning_reports_sheets_queue_v1";

        function safeJsonParse(str, fallback) {
            try { return JSON.parse(str); } catch { return fallback; }
        }

        function genClientReportId() {
            // ×™×™×—×•×“×™ ×œ×›×œ ×“×™×•×•×— (×¢×•×–×¨ ×œ×× ×•×¢ ×›×¤×™×œ×•×™×•×ª ×‘×¦×“ Apps Script)
            try {
                if (crypto?.randomUUID) return crypto.randomUUID();
            } catch {}
            return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
        }

        function getSheetsQueue() {
            return safeJsonParse(localStorage.getItem(SHEETS_QUEUE_KEY), []) || [];
        }

        function setSheetsQueue(q) {
            localStorage.setItem(SHEETS_QUEUE_KEY, JSON.stringify(q));
        }

        function enqueueSheetsReport(reportData) {
            const q = getSheetsQueue();
            q.push(reportData);
            setSheetsQueue(q);
        }

        async function fetchWithTimeout(url, opts, timeoutMs = 4500) {
            const controller = new AbortController();
            const t = setTimeout(() => controller.abort(), timeoutMs);
            try {
                return await fetch(url, { ...opts, signal: controller.signal });
            } finally {
                clearTimeout(t);
            }
        }

        async function sendReportToGoogleSheets(reportData) {
            const url = `${SHEETS_API_URL}?key=${encodeURIComponent(SHEETS_API_KEY)}`;

            // mode:no-cors ×›×“×™ ×œ× ×œ×”×™×ª×§×¢ ×¢×œ CORS (Apps Script).
            // ×”×¢×¨×”: no-cors ×œ× ×××¤×©×¨ ×œ×§×¨×•× ×ª×©×•×‘×”, ××‘×œ ××¡×¤×™×§ ×›×“×™ "×œ×™×¨×•×ª" ××ª ×”×‘×§×©×”.
            await fetchWithTimeout(url, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(reportData),
            }, 4500);
        }

        async function flushSheetsQueue() {
            const q = getSheetsQueue();
            if (!q.length) return;

            // × × ×¡×” ×œ×©×œ×•×— ×œ×¤×™ ×¡×“×¨; ×× × ×›×©×œ - × ×©××™×¨ ×‘×ª×•×¨
            const remaining = [];
            for (const item of q) {
                try {
                    await sendReportToGoogleSheets(item);
                } catch (e) {
                    remaining.push(item);
                }
            }
            setSheetsQueue(remaining);
        }

        async function saveToSheetsReliable(reportData) {
            // ×ª××™×“ × ×©××•×¨ ×§×•×“× ×‘×ª×•×¨ ××§×•××™ ×›×“×™ ×©×œ× × ××‘×“ ×“×™×•×•×— ×× ×”×“×¤×“×¤×Ÿ × ×¡×’×¨/× ×¤×œ
            enqueueSheetsReport(reportData);
            // ×•××– × × ×¡×” ×œ×¨×•×§×Ÿ ××™×“ (×× ××¦×œ×™×— - ×”×ª×•×¨ ×™×ª× ×§×”)
            await flushSheetsQueue();
        }

        // Global Firebase configuration
        let db, auth, appId;
        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'cleaning-checklist-prod';
        } catch (e) {
            console.warn("Firebase not initialized:", e);
        }

        // Constants
        const REASONS = ["×œ× ×”×™×” ×¦×•×•×ª", "×”××§×•× ×œ× ×”×™×” ×¤× ×•×™", "××™×Ÿ ×’×™×©×”", "××—×¨"];
        const TASKS = [
            { id: 'a-pass-1', label: "××¢×‘×¨×™× - ×¡×‘×‘ ×' (×‘×•×§×¨)", group: 'A', building: 'A' },
            { id: 'a-pass-2', label: "××¢×‘×¨×™× - ×¡×‘×‘ ×‘' (×¦×”×¨×™×™×)", group: 'A', building: 'A' },
            { id: 'a-rec-1', label: "×¨×¦×™×¤×™ ×§×‘×œ×” - ×¡×‘×‘ ×'", group: 'A', building: 'A' },
            { id: 'a-rec-2', label: "×¨×¦×™×¤×™ ×§×‘×œ×” - ×¡×‘×‘ ×‘'", group: 'A', building: 'A' },
            { id: 'a-off-dist', label: "××©×¨×“ ×”×¤×¦×”", group: 'A', building: 'A' },
            { id: 'a-off-pick', label: "××©×¨×“ × ×™×”×•×œ ×œ×™×§×•×˜", group: 'A', building: 'A' },
            { id: 'a-off-rec', label: "××©×¨×“ ×§×‘×œ×”", group: 'A', building: 'A' },
            { id: 'a-lobby', label: "×œ×•×‘×™ ×›× ×™×¡×” + ×¤×™× ×ª ×¢×™×©×•×Ÿ", group: 'A', building: 'A' },
            { id: 'a-gallery', label: "××©×¨×“×™× ×’×œ×¨×™×”", group: 'A', building: 'A' },
            { id: 'bg-plat', label: "×¨×¦×™×¤×™× - ×§×¨×§×¢", group: 'B-Ground', building: 'B' },
            { id: 'bu-inner', label: "×¤× ×™× ××—×¡×Ÿ - ×¢×œ×™×•×Ÿ", group: 'B-Upper', building: 'B' },
            { id: 'bu-plat', label: "×¨×¦×™×¤×™× - ×¢×œ×™×•×Ÿ", group: 'B-Upper', building: 'B' },
            { id: 'bu-entry', label: "×›× ×™×¡×” ×¨××©×™×ª - ×¢×œ×™×•×Ÿ", group: 'B-Upper', building: 'B' },
            { id: 'bu-offices', label: "××©×¨×“×™× - ×¢×œ×™×•×Ÿ", group: 'B-Upper', building: 'B' }
        ];

        const COMPLIMENTS = ["××œ×š", "××œ×•×£", "×’×™×‘×•×¨", "×ª×•×ª×—", "×›×•×›×‘", "××§×¦×•×¢×Ÿ", "××’×“×”"];
        const MOTIVATION = [
            "××ª×” ×××© ×§×¨×•×‘! ×¢×•×“ ×›××” ×œ×—×™×¦×•×ª ×•×–×” ××•×©×œ×.",
            "×•×•××•, ×›××¢×˜ ×¡×™×™××ª. ×‘×•× × ×‘×¨×™×§ ××ª ×”××§×•× ×¢×“ ×”×¡×•×£.",
            "×”×’×¢×ª ×œ×ª×•×¦××” ××¨×©×™××”! ×”×©×œ××” ×§×˜× ×” ×•×¡×’×¨×ª ××ª ×”×™×•× ×›×× ×¦×—.",
            "×”××§×•× × ×¨××” × ×”×“×¨ ×‘×–×›×•×ª×š, ×‘×•× × ×¡×’×•×¨ ××ª ×”×§×¦×•×•×ª ×©× ×•×ª×¨×•."
        ];

        // State
        let taskData = {};
        let currentTab = 'A';
        let cloudReports = [];

        // Globalize functions so HTML can see them
        window.switchTab = (tabId) => {
            currentTab = tabId;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tabBtn${tabId}`)?.classList.add('active');

            document.getElementById('contentA').classList.toggle('hidden', tabId !== 'A');
            document.getElementById('contentB').classList.toggle('hidden', tabId !== 'B');
            document.getElementById('contentReports').classList.toggle('hidden', tabId !== 'Reports');
            
            document.getElementById('headerInputs').classList.toggle('hidden', tabId === 'Reports');
            document.getElementById('actionButtons').classList.toggle('hidden', tabId === 'Reports');

            if (tabId === 'Reports') {
                fetchReports();
            } else {
                document.getElementById('nameInputA').classList.toggle('hidden', tabId !== 'A');
                document.getElementById('nameInputB').classList.toggle('hidden', tabId !== 'B');
                document.getElementById('progressLabel').innerText = tabId;
                updateProgress();
            }
        };

        window.setStatus = (id, status) => {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            
            if (taskData[id] && taskData[id].status === status) {
                delete taskData[id];
                updateUI(id, null);
            } else {
                taskData[id] = { status, time: timeStr, reason: taskData[id]?.reason || "", otherText: taskData[id]?.otherText || "" };
                updateUI(id, status);
            }
            saveState();
            updateProgress();
        };

        window.setReason = (id, reason) => {
            if (taskData[id]) {
                taskData[id].reason = reason;
                const otherBox = document.getElementById(`other-input-container-${id}`);
                if (reason === '××—×¨') {
                    otherBox?.classList.remove('hidden');
                } else {
                    otherBox?.classList.add('hidden');
                    taskData[id].otherText = "";
                }
                saveState();
            }
        };

        window.setOtherText = (id, text) => {
            if (taskData[id]) {
                taskData[id].otherText = text;
                saveState();
            }
        };

        window.attemptSend = () => {
            const activeTasks = TASKS.filter(t => t.building === currentTab);
            const handledCount = activeTasks.filter(t => taskData[t.id]).length;
            const doneCount = activeTasks.filter(t => taskData[t.id]?.status === 'done').length;
            const pctDone = Math.round((doneCount / activeTasks.length) * 100);
            
            const name = document.getElementById(`workerName${currentTab}`)?.value || "××“×•×•×— ×™×§×¨";
            
            const modal = document.getElementById('customModal');
            const modalBox = document.getElementById('modalBox');
            const modalTitle = document.getElementById('modalTitle');
            const modalDesc = document.getElementById('modalDescription');
            const modalIcon = document.getElementById('modalIcon');
            const actionBtn = document.getElementById('modalActionBtn');

            modalBox.classList.remove('animate-pop');
            void modalBox.offsetWidth;
            modalBox.classList.add('animate-pop');

            if (handledCount === activeTasks.length && doneCount === activeTasks.length) {
                const randomComp = COMPLIMENTS[Math.floor(Math.random() * COMPLIMENTS.length)];
                modalIcon.innerText = "ğŸ‘‘";
                modalTitle.innerText = `×›×œ ×”×›×‘×•×“, ${name} ×”${randomComp}!`;
                modalDesc.innerHTML = `×”×©×œ××ª 100% ××”××©×™××•×ª ×•×”×›×œ × ×¨××” ××‘×¨×™×§. <br><b>×”××©×¨×“ ××•×›×Ÿ ×œ×™×•× ×—×“×©!</b>`;
                actionBtn.className = "w-full bg-green-500 text-white py-4 rounded-2xl font-bold text-lg shadow-lg";
            } else if (handledCount === activeTasks.length) {
                modalIcon.innerText = "âœ…";
                modalTitle.innerText = `×¢×‘×•×“×” ×˜×•×‘×”, ${name}`;
                modalDesc.innerHTML = `×”×©×œ××ª ××ª ×”×˜×•×¤×¡ (×‘×™×¦×•×¢: ${pctDone}%). <br>×”×× ×œ×©×œ×•×— ××ª ×”×“×™×•×•×— ×”××¢×•×“×›×Ÿ?`;
                actionBtn.className = "w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg";
            } else {
                const randomMotivation = MOTIVATION[Math.floor(Math.random() * MOTIVATION.length)];
                modalIcon.innerText = "ğŸ’ª";
                modalTitle.innerText = `×¨×’×¢, ${name}...`;
                modalDesc.innerHTML = `×“×™×•×•×—×ª ×¨×§ ×¢×œ ${pctDone}% ××”××©×™××•×ª. <br>${randomMotivation}`;
                actionBtn.className = "w-full bg-orange-500 text-white py-4 rounded-2xl font-bold text-lg shadow-lg";
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.confirmSend = async () => {
            closeModal();
            const btn = document.getElementById('sendReportBtn');
            const loader = document.getElementById('btnLoader');
            const icon = document.getElementById('whatsappIcon');
            
            if(btn) btn.disabled = true;
            loader?.classList.remove('hidden');
            icon?.classList.add('hidden');

            const name = document.getElementById(`workerName${currentTab}`)?.value || "×œ× ×¦×•×™×Ÿ";
            const dateStr = new Date().toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: '2-digit' });
            
            const reportData = {
                building: currentTab,
                workerName: name,
                date: dateStr,
                timestamp: serverTimestamp ? serverTimestamp() : new Date(),
                // ××–×”×” ×™×™×—×•×“×™ ×œ×›×œ ×“×™×•×•×— (×œ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª ×‘-Sheets)
                clientReportId: genClientReportId(),
                tasks: TASKS.filter(t => t.building === currentTab).map(t => {
                    const data = taskData[t.id];
                    return {
                        label: t.label,
                        status: data ? data.status : 'none',
                        time: data ? data.time : '',
                        reason: data ? (data.reason === '××—×¨' ? data.otherText : data.reason) : ''
                    };
                })
            };

            let msg = `ğŸ“¢ *× ×™×§×™×•×Ÿ ×™×•××™ - ××‘× ×” ${currentTab}* ğŸ“¢\n\n`;
            msg += `ğŸ‘¤ *××‘×¦×¢:* ${name}\nğŸ“… *×ª××¨×™×š:* ${dateStr}\n\n`;
            
            reportData.tasks.forEach(t => {
                if (t.status === 'none') {
                    msg += `âšª ×œ× ×“×•×•×—: ${t.label}\n`;
                } else if (t.status === 'done') {
                    msg += `âœ… ×‘×•×¦×¢: ${t.label} (${t.time})\n`;
                } else {
                    msg += `âŒ ×œ× ×‘×•×¦×¢: ${t.label} (${t.time}) - ${t.reason || '×œ×œ× ×¡×™×‘×”'}\n`;
                }
            });

            // 1) Firebase (×›××• ×©×”×™×”)
            try {
                if (auth?.currentUser) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), reportData);
                }
            } catch (e) { console.error("Cloud save failed:", e); }

            // 2) Google Sheets (DB) - ×©××™×¨×” ×××™× ×” ×¢× ×ª×•×¨ ××•×¤×œ×™×™×Ÿ
            try {
                await saveToSheetsReliable(reportData);
            } catch (e) {
                // ×’× ×× ×–×” × ×•×¤×œ - ×”×“×•×— ×›×‘×¨ ×‘×ª×•×¨ ××§×•××™; ×™×™×©×œ×— ×‘×”××©×š
                console.warn("Sheets save queued (offline/retry):", e);
            }

            // 3) WhatsApp (×›××• ×©×”×™×”)
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            
            if(btn) btn.disabled = false;
            loader?.classList.add('hidden');
            icon?.classList.remove('hidden');

            setTimeout(() => {
                if (confirm(`×”×× ×œ××¤×¡ ××ª ×¨×©×™××ª ××‘× ×” ${currentTab} ×œ×™×•× ×—×“×©?`)) {
                    TASKS.filter(t => t.building === currentTab).forEach(t => {
                        delete taskData[t.id];
                        updateUI(t.id, null);
                    });
                    saveState();
                    updateProgress();
                }
            }, 1000);
        };

        window.closeModal = () => {
            document.getElementById('customModal')?.classList.add('hidden');
            document.getElementById('customModal')?.classList.remove('flex');
        };

        window.resetChecklist = () => {
            if (confirm('×œ××¤×¡ ××ª ×›×œ ×”××©×™××•×ª (××‘× ×” A ×•×’× B)?')) {
                taskData = {}; localStorage.removeItem('cleaning_v17_stable'); location.reload();
            }
        };

        window.exportToCSV = () => {
            if (cloudReports.length === 0) { alert("××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×"); return; }
            let csv = "\uFEFF×ª××¨×™×š,××‘× ×”,××“×•×•×—,××©×™××”,×¡×˜×˜×•×¡,×–××Ÿ,×¡×™×‘×”\n";
            cloudReports.forEach(rep => {
                const d = rep.timestamp?.toDate ? rep.timestamp.toDate().toLocaleString('he-IL') : rep.date;
                rep.tasks.forEach(t => {
                    csv += `${d},${rep.building},${rep.workerName},${t.label},${t.status === 'done' ? '×‘×•×¦×¢' : '×œ× ×‘×•×¦×¢'},${t.time},${t.reason || ''}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `cleaning_history_${Date.now()}.csv`);
            link.click();
        };

        // --- Logic UI ---

        function renderTasks() {
            ['group-A', 'group-B-Ground', 'group-B-Upper'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '';
            });

            TASKS.forEach(task => {
                const container = document.getElementById(`group-${task.group}`);
                if (!container) return;
                
                const html = `
                    <div class="task-card p-4 task-row" data-id="${task.id}" data-building="${task.building}" data-label="${task.label}">
                        <div class="flex items-center justify-between">
                            <span class="text-slate-700 font-bold text-sm ml-2">${task.label}</span>
                            <div class="flex gap-2 shrink-0">
                                <button onclick="window.setStatus('${task.id}', 'done')" class="status-btn btn-done" id="btn-done-${task.id}">âœ“</button>
                                <button onclick="window.setStatus('${task.id}', 'not_done')" class="status-btn btn-not-done" id="btn-not-done-${task.id}">âœ•</button>
                            </div>
                        </div>
                        <div id="reason-container-${task.id}" class="reason-select mt-3 space-y-2 border-t pt-3 border-slate-50">
                            <div>
                                <label class="block text-[10px] text-slate-400 font-bold mb-1 mr-1 uppercase">×¡×™×‘×” ×œ××™-×‘×™×¦×•×¢:</label>
                                <select id="select-${task.id}" onchange="window.setReason('${task.id}', this.value)" class="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg text-xs outline-none">
                                    <option value="">×‘×—×¨ ×¡×™×‘×”...</option>
                                    ${REASONS.map(r => `<option value="${r}">${r}</option>`).join('')}
                                </select>
                            </div>
                            <div id="other-input-container-${task.id}" class="hidden">
                                <input type="text" id="other-text-${task.id}" oninput="window.setOtherText('${task.id}', this.value)" placeholder="×¤×¨×˜ ×¡×™×‘×” ××—×¨×ª..." class="w-full bg-white border border-slate-200 p-2 rounded-lg text-xs outline-none">
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function updateUI(id, status) {
            const doneBtn = document.getElementById(`btn-done-${id}`);
            const notDoneBtn = document.getElementById(`btn-not-done-${id}`);
            const reasonBox = document.getElementById(`reason-container-${id}`);
            const otherBox = document.getElementById(`other-input-container-${id}`);
            const select = document.getElementById(`select-${id}`);
            const otherInp = document.getElementById(`other-text-${id}`);

            if (doneBtn) doneBtn.classList.toggle('active', status === 'done');
            if (notDoneBtn) notDoneBtn.classList.toggle('active', status === 'not_done');
            
            if (status === 'not_done') {
                reasonBox?.classList.add('visible');
                if (taskData[id]?.reason === '××—×¨') otherBox?.classList.remove('hidden');
            } else {
                reasonBox?.classList.remove('visible');
                otherBox?.classList.add('hidden');
            }

            if (taskData[id]) {
                if (select) select.value = taskData[id].reason || "";
                if (otherInp) otherInp.value = taskData[id].otherText || "";
            }
        }

        function updateProgress() {
            const activeTasks = TASKS.filter(t => t.building === currentTab);
            const handled = activeTasks.filter(t => taskData[t.id]).length;
            const pct = activeTasks.length > 0 ? Math.round((handled / activeTasks.length) * 100) : 0;
            
            const pb = document.getElementById('progressBar');
            const pt = document.getElementById('progressText');
            if (pb) pb.style.width = pct + '%';
            if (pt) pt.innerText = pct + '%';
        }

        function saveState() {
            const nameA = document.getElementById('workerNameA')?.value || "";
            const nameB = document.getElementById('workerNameB')?.value || "";
            localStorage.setItem('cleaning_v17_stable', JSON.stringify({ tasks: taskData, nameA, nameB }));
        }

        function loadState() {
            const saved = JSON.parse(localStorage.getItem('cleaning_v17_stable')) || {};
            taskData = saved.tasks || {};
            const workerNameA = document.getElementById('workerNameA');
            const workerNameB = document.getElementById('workerNameB');
            if (workerNameA && saved.nameA) workerNameA.value = saved.nameA;
            if (workerNameB && saved.nameB) workerNameB.value = saved.nameB;
            
            TASKS.forEach(t => {
                if (taskData[t.id]) updateUI(t.id, taskData[t.id].status);
            });
            updateProgress();
        }

        async function fetchReports() {
            const list = document.getElementById('reportsHistoryList');
            if (!list) return;
            list.innerHTML = '<div class="text-center py-10 text-slate-400 text-sm">×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×”...</div>';
            
            try {
                if (!auth?.currentUser) {
                    list.innerHTML = '<div class="text-center py-10 text-slate-400 text-sm">×××ª×™×Ÿ ×œ×—×™×‘×•×¨ ×¢× ×Ÿ...</div>';
                    return;
                }
                const path = collection(db, 'artifacts', appId, 'public', 'data', 'reports');
                const snap = await getDocs(path);
                cloudReports = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                cloudReports.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                if (cloudReports.length === 0) {
                    list.innerHTML = '<div class="text-center py-10 text-slate-400 text-sm italic">××™×Ÿ ×“×™×•×•×—×™× ×§×•×“××™× ×‘×¢× ×Ÿ.</div>';
                    return;
                }

                list.innerHTML = cloudReports.map(rep => {
                    const dObj = rep.timestamp?.toDate ? rep.timestamp.toDate() : new Date();
                    return `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-2">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-blue-600 text-sm">××‘× ×” ${rep.building}</span>
                                <span class="text-[10px] text-slate-400 font-mono">${dObj.toLocaleString('he-IL')}</span>
                            </div>
                            <div class="text-xs text-slate-500 font-bold">××“×•×•×—: ${rep.workerName}</div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                list.innerHTML = '<div class="text-center py-10 text-red-400 text-sm">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×.</div>';
            }
        }

        function updateClock() {
            const now = new Date();
            const timeEl = document.getElementById('currentTime');
            const dateEl = document.getElementById('currentDate');
            if (timeEl) timeEl.innerText = now.toLocaleTimeString('he-IL', { hour12: false });
            if (dateEl) dateEl.innerText = now.toLocaleDateString('he-IL', { weekday: 'long', day: 'numeric', month: 'numeric', year: 'numeric' });
        }

        // Initialize UI Immediately
        renderTasks();
        loadState();
        updateClock();
        setInterval(updateClock, 1000);

        // Sheets queue: × ×¡×” ×œ×©×œ×•×— ××”×ª×•×¨ ××™×“ ×‘×”×¤×¢×œ×”, ×•×‘×›×œ ×“×§×”
        flushSheetsQueue();
        setInterval(flushSheetsQueue, 60 * 1000);
        window.addEventListener('online', () => flushSheetsQueue());

        // Name input listeners
        document.getElementById('workerNameA')?.addEventListener('input', saveState);
        document.getElementById('workerNameB')?.addEventListener('input', saveState);

        // Async Init for Firebase
        const startApp = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else if (auth) {
                    await signInAnonymously(auth);
                }
            } catch (e) { 
                console.warn("Auth process skipped/failed."); 
            }
        };
        startApp();

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user && currentTab === 'Reports') fetchReports();
            });
        }

    </script>
</body>
</html>
